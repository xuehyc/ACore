aaDataPet = {}; aaDataPet.frame = nil; function aaDataPet:getItem(itemid, itementry) if itemid == 0 or itementry == 0 then return nil; end; if petitems[itemid] == nil then return nil; end; return petitems[itemid][itementry]; end; function aaDataPet:get_quality(itemid, itementry) local item = aaDataPet:getItem(itemid, itementry); if item then local qualityid = item[6]; if qualityid and qualityid > 0 and petnonsuch[qualityid] then return petnonsuch[qualityid][3]; end; end; return ""; end; function aaDataPet:get_quality_color(itemid, itementry) local item = aaDataPet:getItem(itemid, itementry); if item then local qualityid = item[6]; if qualityid and qualityid > 0 and petnonsuch[qualityid] then return petnonsuch[qualityid][4]; end; end; return ""; end; function aaDataPet:get_dbname(itemid, itementry, name) return aaDataPet:get_quality_color(itemid, itementry)..name; end; function aaDataPet:get_name(itemid, itementry, name) local item = aaDataPet:getItem(itemid, itementry); if item then local name1 = item[5]; if name1 and name1 ~= "" then return aaDataPet:get_quality_color(itemid, itementry)..name1; end; end; return aaDataPet:get_dbname(itemid, itementry, name); end; function aaDataPet:GetAllHttpItem() local itemids = ""; local itementrys = ""; local i = 1; for bag = 0,4 do for slot = 1,GetContainerNumSlots(bag) do local itemLink = GetContainerItemLink(bag,slot); if itemLink then local itemString = string.match(itemLink, "item[%-?%d:]+"); local _, itemId, _, _, suffixId1, suffixId2, _, _, _, _= strsplit(":", itemString); local suffixId = (suffixId1 - 5000) * 10000 + suffixId2 - 5000; itemids = itemids..suffixId.."\t"..itemId.."\t"; local item = aaDataPet:getItem(suffixId, itemId); if item then itemids = itemids..item[26].."\t"; else itemids = itemids.."0".."\t"; end; itementrys = itementrys..itemId.."\t"; i = i + 1; end; end; end; for i = 0,23 do local itemLink = GetInventoryItemLink("player", i); if itemLink then local itemString = string.match(itemLink, "item[%-?%d:]+"); local _, itemId, _, _, suffixId1, suffixId2, _, _, _, _= strsplit(":", itemString); local suffixId = (suffixId1 - 5000) * 10000 + suffixId2 - 5000; itemids = itemids..suffixId.."\t"..itemId.."\t"; local item = aaDataPet:getItem(suffixId, itemId); if item then itemids = itemids..item[26].."\t"; else itemids = itemids.."0".."\t"; end; itementrys = itementrys..itemId.."\t"; i = i + 1; end; end; for i = 40,74 do local itemLink = GetInventoryItemLink("player", i); if itemLink then local itemString = string.match(itemLink, "item[%-?%d:]+"); local _, itemId, _, _, suffixId1, suffixId2, _, _, _, _= strsplit(":", itemString); local suffixId = (suffixId1 - 5000) * 10000 + suffixId2 - 5000; itemids = itemids..suffixId.."\t"..itemId.."\t"; local item = aaDataPet:getItem(suffixId, itemId); if item then itemids = itemids..item[26].."\t"; else itemids = itemids.."0".."\t"; end; itementrys = itementrys..itemId.."\t"; i = i + 1; end; end; aaData:sendAddonMsg(110, itemids, "GUILD"); end; function aaDataPet:GetHttpItem(itemid, itementry) local itemid1 = ""; local item = aaDataPet:getItem(itemid, itementry); if item then itemid1 = itemid.."\t"..itementry.."\t"..item[26]; else itemid1 = itemid.."\t"..itementry.."\t"..0; end; aaData:sendAddonMsg(110, itemid1, "GUILD"); end; function aaDataPet:getHttpSpell(k, k1) local item = aaDataPet:getItem(k, k1); if item then local spellids = ""; if item[16] ~= "" and item[16] ~= "0" and item[16] ~= 0 then local qhtext1 = item[16]; local qhids = {}; string.gsub(qhtext1,'[^'..","..']+',function (w) table.insert(qhids,w); end); if qhids ~= {} then qhids = aaData:RemoveRepetition(qhids); end; for i=1,#qhids do local spellid = qhids[i] + 0; if spellid ~= "" and spellid ~= "0" and spellid ~= 0 then spellids = spellids..spellid.."\t"; if spells[spellid] then spellids = spellids..spells[spellid][2].."\t"; else spellids = spellids.."0".."\t"; end; end; end; end; if item[24] ~= "" and item[24] ~= "0" and item[24] ~= 0 then local qhtext1 = item[24]; local qhids = {}; string.gsub(qhtext1,'[^'..","..']+',function (w) table.insert(qhids,w); end); for i=1,#qhids do local spellid = qhids[i] + 0; if spellid ~= "" and spellid ~= "0" and spellid ~= 0 then spellids = spellids..spellid.."\t"; if spells[spellid] then spellids = spellids..spells[spellid][2].."\t"; else spellids = spellids.."0".."\t"; end; end; end; end; if item[26] ~= "" and item[26] ~= "0" and item[26] ~= 0 then local qhtext1 = item[26]; local qhids = {}; string.gsub(qhtext1,'[^'..","..']+',function (w) table.insert(qhids,w); end); for i=1,#qhids do local spellid = qhids[i] + 0; if spellid ~= "" and spellid ~= "0" and spellid ~= 0 then spellids = spellids..spellid.."\t"; if spells[spellid] then spellids = spellids..spells[spellid][2].."\t"; else spellids = spellids.."0".."\t"; end; end; end; end; if spellids ~= "" then aaData:sendAddonMsg(11, spellids, "GUILD"); end; end; end; function ONADDONMSG(self, event, prefix, msg, Type, sender) if event == "PLAYER_LOGIN" then if petitems == nil then petitems = {}; end; if petnonsuch == nil then petnonsuch = {}; end; if petupgrade == nil then petupgrade = {}; end; if petrune == nil then petrune = {}; end; aaData:sendAddonMsg(111, "0", "GUILD"); aaData:sendAddonMsg(112, "0", "GUILD"); aaData:sendAddonMsg(113, "0", "GUILD"); elseif event == "CHAT_MSG_ADDON" and sender == UnitName("player") then if prefix == "111" then rtable = loadstring("return " .. msg)(); if rtable then for k,v in pairs(rtable) do petnonsuch[k] = rtable[k]; end; end; elseif prefix == "112" then rtable = loadstring("return " .. msg)(); if rtable then for k,v in pairs(rtable) do petupgrade[k] = rtable[k]; end; end; elseif prefix == "113" then rtable = loadstring("return " .. msg)(); if rtable then for k,v in pairs(rtable) do petrune[k] = rtable[k]; end; end; elseif prefix == "100" or prefix == "101" or prefix == "102" or prefix == "103" or prefix == "104" then aaPetFrame:CallBack(prefix); elseif prefix == "110" then rtable = loadstring("return " .. msg)(); for k,v in pairs(rtable) do if rtable[k] then petitems[k] = rtable[k]; end; end; aaPetFrame:reload(); elseif prefix == "150" then aaPetFrame:show(); aaDzFrame:hide(); end; end; end; do aaDataPet.frame = CreateFrame("Frame"); aaDataPet.frame:RegisterEvent("CHAT_MSG_ADDON"); aaDataPet.frame:RegisterEvent("PLAYER_LOGIN"); aaDataPet.frame:SetScript("OnEvent", ONADDONMSG); end;