local _G = _G; local GameTooltip = GameTooltip; local ItemRefTooltip = ItemRefTooltip; local ShoppingTooltip1 = ShoppingTooltip1; local ShoppingTooltip2 = ShoppingTooltip2; local ShoppingTooltip2 = ShoppingTooltip3; aaFwTooltipRight = {}; aaFwTooltipRight.selectItem = {}; aaFwTooltipRight.mainView = {}; aaFwTooltipRight.fwbtns = {}; aaFwTooltipRight.fwtexts = {}; aaFwTooltipRight.fwzhtexts = {}; local fontSize = 14; local left = 10; local top = -10; local space = 50; local fwtextspace = fontSize+5; local menuSize = 50; local textHeight = 15; local buttonSize = 30; local fwheight = 0; local fwwidth = 0; local IconView = function(x,y,icon,text) local menuView = CreateFrame("Frame",nil,aaFwTooltipRight.mainView) do menuView:SetFrameStrata("TOOLTIP"); menuView:SetWidth(menuSize); menuView:SetHeight(menuSize); menuView:SetPoint("TOPLEFT",aaFwTooltipRight.mainView,'TOPLEFT',x,y); menuView:Hide(); end; menuView.IconText = menuView:CreateFontString("menuView.IconText", "OVERLAY", "GameFontNormal") do menuView.IconText:SetPoint("TOPLEFT", menuView, "TOPLEFT", 0, -buttonSize); menuView.IconText:SetFont("Interface\\AddOns\\aaAddon\\Font\\aaFont.TTF", fontSize); menuView.IconText:SetWidth(menuSize); menuView.IconText:SetHeight(fontSize); menuView.IconText:SetSpacing(0); menuView.IconText:SetText(text); end; menuView.IconButton = CreateFrame('Button', nil, menuView, '') do menuView.IconButton:SetPoint('CENTER', menuView, 'CENTER', 0, (menuSize-buttonSize)/2+2); menuView.IconButton:SetNormalTexture(icon); menuView.IconButton:SetWidth(buttonSize); menuView.IconButton:SetHeight(buttonSize); end; return menuView; end; local FwText = function(x,y,text) local fwtext = aaFwTooltipRight.mainView:CreateFontString("fwtext", "OVERLAY", "GameFontNormal") do fwtext:SetText(text); fwtext:SetFont("Interface\\AddOns\\aaAddon\\Font\\aaFont.TTF", fontSize); fwtext:SetPoint("TOPLEFT", aaFwTooltipRight.mainView, "TOPLEFT", x, y); end; return fwtext; end; aaFwTooltipRight.mainView = CreateFrame("Frame",nil,UIParent) do aaFwTooltipRight.mainView:SetFrameStrata("TOOLTIP"); aaFwTooltipRight.mainView:SetBackdrop({ bgFile = 'Interface\\DialogFrame\\UI-DialogBox-Background', edgeFile = 'Interface\\Tooltips\\UI-Tooltip-Border', tile = true, edgeSize = 16, tileSize = 16, insets = { left = 4, right = 4, top = 4, bottom = 4 } }); aaFwTooltipRight.mainView:SetWidth(470); aaFwTooltipRight.mainView:SetHeight(365); aaFwTooltipRight.mainView:SetToplevel(true); aaFwTooltipRight.mainView:SetClampedToScreen(true); aaFwTooltipRight.mainView:Hide(); aaFwTooltipRight.mainView.fwtitleText = FwText(left,top,aaData.color_yellow.."[神符之语]"..""); end; function aaFwTooltipRight:reload() fwheight = 0; fwwidth = 0; if aaFwTooltipRight.mainView.fwzuheText then aaFwTooltipRight.mainView.fwzuheText:Hide(); aaFwTooltipRight.mainView.fwzuheText = nil; end; for i=1,30 do if aaFwTooltipRight.fwbtns[i] then aaFwTooltipRight.fwbtns[i]:Hide(); aaFwTooltipRight.fwbtns[i] = nil; end; if aaFwTooltipRight.fwtexts[i] then aaFwTooltipRight.fwtexts[i]:Hide(); aaFwTooltipRight.fwtexts[i] = nil; end; if aaFwTooltipRight.fwzhtexts[i] then aaFwTooltipRight.fwzhtexts[i]:Hide(); aaFwTooltipRight.fwzhtexts[i] = nil; end; end; if aaFwTooltipRight.selectItem ~= nil and aaFwTooltipRight.selectItem ~= {} then local itemCount = aaFwTooltipRight.selectItem[32] + 0; local fwCount = 0; local fwzhCount = 0; local fwids = aaData:toVectorInt(aaFwTooltipRight.selectItem[33]); if itemCount > 0 then local jj = 0; for j=1,itemCount do local itementry = 0; if fwids[j] then itementry = fwids[j]+0; end; if itementry > 0 then fwCount = fwCount + 1; end; end; end; local w = space * fwCount; if fwwidth < w then fwwidth = w; end; local count_n = 0; local count_n_zh = 0; if fwCount > 0 then local jj = 0; for j=1,fwCount do local itementry = 0; if fwids[j] then itementry = fwids[j]+0; end; local icon = ""; local name = ""; if itementry > 0 then jj = jj + 1; name = aaData:getItemName(itementry); icon = GetItemIcon(itementry); local spelltext = aa_fw[itementry]; aaFwTooltipRight.fwtexts[j] = FwText(left,top-fontSize-10-menuSize-fwtextspace*(jj-1) - count_n * 14,spelltext); for word in string.gmatch(spelltext, "|n") do count_n = count_n + 1; end; local w = aaFwTooltipRight.fwtexts[j]:GetStringWidth(); if fwwidth < w then fwwidth = w; end; end; aaFwTooltipRight.fwbtns[j] = IconView(left + space * (j-1),top-fontSize-10,icon,name); end; local fwzhidstr = aaFwTooltipRight.selectItem[34]; local fwzhids = {}; string.gsub(fwzhidstr,'[^'..","..']+',function (w) table.insert(fwzhids,w); end); for i=1,#fwzhids do local fwzhid = fwzhids[i] + 0; if fwzhid > 0 then local spelltext = aa_fwzh[fwzhid][1]; aaFwTooltipRight.fwzhtexts[i] = FwText(left,top-fontSize-10-menuSize-10-fwtextspace*(fwCount+i) - (count_n +count_n_zh) * 14,spelltext); for word in string.gmatch(spelltext, "|n") do count_n_zh = count_n_zh + 1; end; local w = aaFwTooltipRight.fwzhtexts[i]:GetStringWidth(); if fwwidth < w then fwwidth = w; end; fwzhCount = fwzhCount + 1; end; end; end; if fwCount == 0 then fwheight = -top+fontSize+10+menuSize; aaFwTooltipRight.mainView:Hide(); else fwheight = -top+fontSize+10+menuSize + fwtextspace*fwCount + 10 + (count_n + count_n_zh) * 14; aaFwTooltipRight.mainView:Show(); end; if fwzhCount > 0 then aaFwTooltipRight.mainView.fwzuheText = FwText(left,top-fontSize-10-menuSize-10-fwtextspace*fwCount - count_n * 14,aaData.color_yellow.."[组合效果]"..""); local w = aaFwTooltipRight.mainView.fwzuheText:GetStringWidth(); if fwwidth < w then fwwidth = w; end; fwheight = fwheight + 10 + fwtextspace*(fwzhCount+1); end; aaFwTooltipRight.mainView:SetHeight(fwheight); aaFwTooltipRight.mainView:SetWidth(fwwidth+left*2); end; end; function aaFwTooltipRight:show(item) aaFwTooltipRight.selectItem = item; aaFwTooltipRight:reload(); for i=1,#(aaFwTooltipRight.fwbtns) do local view = aaFwTooltipRight.fwbtns[i]; if view ~= nil then view:Show(); end; end; end; function aaFwTooltipRight:hide() if aaFwTooltipRight.mainView and aaFwTooltipRight.mainView ~= nil and aaFwTooltipRight.mainView ~= {} then aaFwTooltipRight.mainView:Hide(); aaFwTooltipRight.selectItemId = 0; end; end;