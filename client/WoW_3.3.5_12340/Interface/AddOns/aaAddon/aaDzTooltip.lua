local _G = _G; local GameTooltip = GameTooltip; local ItemRefTooltip = ItemRefTooltip; local ShoppingTooltip1 = ShoppingTooltip1; local ShoppingTooltip2 = ShoppingTooltip2; local ShoppingTooltip2 = ShoppingTooltip3; aaDzTooltip = {}; aaDzTooltip.fwhide = 0; local selectVendorEntry = 0; local selectCreatureEntry = 0; local selectItemId = 0; local selectItemIdPre = 0; local selectItemIdPres = {}; local get_jd_fontstring = function(self) local ii = 2; local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; ii = 3; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=ii,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); if text then _, q=string.find(mytext:GetText(), "单手"); if q == nil then _, q=string.find(mytext:GetText(), "双手"); end; if q == nil then _, q=string.find(mytext:GetText(), "主手"); end; if q == nil then _, q=string.find(mytext:GetText(), "远程"); end; if q == nil then _, q=string.find(mytext:GetText(), "投掷"); end; if q == nil then _, q=string.find(mytext:GetText(), "副手"); end; if q == nil then _, q=string.find(mytext:GetText(), "头部"); end; if q == nil then _, q=string.find(mytext:GetText(), "肩部"); end; if q == nil then _, q=string.find(mytext:GetText(), "胸部"); end; if q == nil then _, q=string.find(mytext:GetText(), "腿部"); end; if q == nil then _, q=string.find(mytext:GetText(), "手腕"); end; if q == nil then _, q=string.find(mytext:GetText(), "腰部"); end; if q == nil then _, q=string.find(mytext:GetText(), "头部"); end; if q == nil then _, q=string.find(mytext:GetText(), "背部"); end; if q == nil then _, q=string.find(mytext:GetText(), "衬衣"); end; if q == nil then _, q=string.find(mytext:GetText(), "战袍"); end; if q == nil then _, q=string.find(mytext:GetText(), "圣物"); end; if q == nil then _, q=string.find(mytext:GetText(), "颈部"); end; if q == nil then _, q=string.find(mytext:GetText(), "手指"); end; if q == nil then _, q=string.find(mytext:GetText(), "饰品"); end; if q == nil then _, q=string.find(mytext:GetText(), "手"); end; if q == nil then _, q=string.find(mytext:GetText(), "脚"); end; if q == nil then _, q=string.find(mytext:GetText(), "容器"); end; if q ~= nil then return _G[pretext.."TextLeft"..i]; end; end; end; end; return nil; end; local get_bs_fontstring = function(self) for i=2,self:NumLines() do local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); _, qe=string.find(mytext:GetText(), "QQ643125009"); if qe ~= nil then return _G[pretext.."TextLeft"..i]; end; end; end; return nil; end; local get_level_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=2,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); _, qe=string.find(mytext:GetText(), "需要等级"); if qe ~= nil then return _G[pretext.."TextLeft"..i]; end; end; end; return nil; end; local get_jl_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=2,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); _, qe=string.find(mytext:GetText(), "装备："); if qe ~= nil then return _G[pretext.."TextLeft"..i-1]; end; end; end; return nil; end; local get_fm_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=2,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); _, qe=string.find(text, "\""); if qe == nil then _, qe=string.find(mytext:GetText(), "(%d+/%d+)"); end; if qe ~= nil then return _G[pretext.."TextLeft"..i-1]; end; end; return _G[pretext.."TextLeft"..self:NumLines()]; end; return nil; end; local get_fg_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=2,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); if text then _, qe=string.find(text, "%d点护甲"); if qe == nil then _, qe=string.find(text, "(%d+).*-.*(%d+)伤害"); end; if qe == nil then _, qe=string.find(text, "%d格挡"); end; if qe ~= nil then return _G[pretext.."TextLeft"..i]; end; end; end; end; return nil; end; local get_last_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=1,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); if text == nil or text == "" then local j = i - 1; return _G[pretext.."TextLeft"..j]; end; end; end; return nil; end; local get_delay_fontstring = function(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext then for i=1,self:NumLines() do local mytext=_G[pretext.."TextRight"..i]; local text=mytext:GetText(); if text then _, qe=string.find(text, "速度"); if qe ~= nil then return _G[pretext.."TextRight"..i]; end; end; end; end; return nil; end; function string.autoLine(inputstr, num) local lenInByte = #inputstr; local width = 0; local i = 1; local line = 1; local res = ""; while (i<=lenInByte) do local curByte = string.byte(inputstr, i); local byteCount = 1; if curByte>0 and curByte<=127 then byteCount = 1; elseif curByte>=192 and curByte<223 then byteCount = 2; elseif curByte>=224 and curByte<=239 then byteCount = 3; elseif curByte>=240 and curByte<=247 then byteCount = 4; end; local char = string.sub(inputstr, i, i+byteCount-1); res = res..char; i = i + byteCount; if byteCount == 1 then width = width + 0.5; else width = width + 1; end; local num1 = num; if line == 1 then num1 = num + 12; end; if width >= num1 then res = res.."\n"; width = 0; line = line + 1; end; end; return res; end; function ShowItemInfo(self) local pretext = nil; if self == GameTooltip then pretext = "GameTooltip"; elseif self == ItemRefTooltip then pretext = "ItemRefTooltip"; elseif self == ShoppingTooltip1 then pretext = "ShoppingTooltip1"; elseif self == ShoppingTooltip2 then pretext = "ShoppingTooltip2"; elseif self == ShoppingTooltip3 then pretext = "ShoppingTooltip3"; end; if pretext == nil then return; end; aaDesktop.aaBoss:hide(); local name, itemLink = self:GetItem(); if itemLink == nil then return; end; local itemString = string.match(itemLink, "item[%-?%d:]+"); local _, itementry, _, _, suffixId1, suffixId2, _, _, _, _= strsplit(":", itemString); local suffixId = (suffixId1 - 5000) * 10000 + suffixId2 - 5000; itementry = itementry + 0; selectItemId = suffixId - 0; if itemtemplates[itementry] == nil then itemtemplates[itementry] = {}; aaData:sendAddonMsg(13, itementry, "GUILD"); end; local item = nil; local bottomtext = ""; local tiaojiantext = ""; local tiaojiantext1 = ""; local fm = get_fm_fontstring(self); local ll = get_level_fontstring(self); if selectItemId > 0 then local currentTime = GetTime(); local timeLen = currentTime - aaData.updateTime; if selectItemIdPre ~= selectItemId then if selectItemIdPres[selectItemId] ~= nil and selectItemIdPres[selectItemId] > 0 then if timeLen > 3 then aaData.updateTime = currentTime; aaData:GetHttpItem(selectItemId, itementry); aaData:getHttpSpell(selectItemId, itementry); aaDataPet:GetHttpItem(selectItemId, itementry); aaDataPet:getHttpSpell(selectItemId, itementry); end; else aaData:GetHttpItem(selectItemId, itementry); aaData:getHttpSpell(selectItemId, itementry); aaDataPet:GetHttpItem(selectItemId, itementry); aaDataPet:getHttpSpell(selectItemId, itementry); end; else if self == ItemRefTooltip then aaData:GetHttpItem(selectItemId, itementry); aaData:getHttpSpell(selectItemId, itementry); aaDataPet:GetHttpItem(selectItemId, itementry); aaDataPet:getHttpSpell(selectItemId, itementry); else if timeLen > 3 then aaData.updateTime = currentTime; aaData:GetHttpItem(selectItemId, itementry); aaData:getHttpSpell(selectItemId, itementry); aaDataPet:GetHttpItem(selectItemId, itementry); aaDataPet:getHttpSpell(selectItemId, itementry); end; end; end; end; local isPet = 0; if selectItemId > 0 then item = aaDataPet:getItem(selectItemId, itementry); if fm ~= nil and item and item ~= {} then fm:SetSpacing(4); if self == GameTooltip then GameTooltipTextLeft2:SetText("宠物\n"..GameTooltipTextLeft2:GetText()); GameTooltipTextLeft2:SetSpacing(4); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft2:SetText("宠物\n"..ItemRefTooltipTextLeft2:GetText()); ItemRefTooltipTextLeft2:SetSpacing(4); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft2:SetText("宠物\n"..ShoppingTooltip1TextLeft2:GetText()); ShoppingTooltip1TextLeft2:SetSpacing(4); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft2:SetText("宠物\n"..ShoppingTooltip2TextLeft2:GetText()); ShoppingTooltip2TextLeft2:SetSpacing(4); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft2:SetText("宠物\n"..ShoppingTooltip3TextLeft2:GetText()); ShoppingTooltip3TextLeft2:SetSpacing(4); end; if item[8] > 0 then if self == GameTooltip then GameTooltipTextLeft1:SetText(aaDataPet:get_dbname(selectItemId, itementry,item[5])); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft1:SetText(aaDataPet:get_dbname(selectItemId, itementry,item[5])); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft1:SetText(aaDataPet:get_dbname(selectItemId, itementry,item[5])); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft1:SetText(aaDataPet:get_dbname(selectItemId, itementry,item[5])); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft1:SetText(aaDataPet:get_dbname(selectItemId, itementry,item[5])); end; local petnonsuchid = item[6]; local leveltext = ""; if petnonsuch[petnonsuchid] then leveltext = petnonsuch[petnonsuchid][3]; end; local upgradeid = item[8]; local mjtext = ""; if item[12] then mjtext = item[12].."%"; end; local lltext = ""; if item[13] then lltext = item[13].."%"; end; local zltext = ""; if item[14] then zltext = item[14].."%"; end; local jstext = ""; if item[15] then jstext = item[15].."%"; end; local nltext = ""; if item[16] then nltext = item[16].."%"; end; if item[20] > 0 then mjtext = mjtext.." + "..item[20].."%"; lltext = lltext.." + "..item[20].."%"; zltext = zltext.." + "..item[20].."%"; jstext = jstext.." + "..item[20].."%"; nltext = nltext.." + "..item[20].."%"; end; local spellid = item[10]; local runeid = item[23]; local spellids = aaData:toVectorInt(item[11]); local runetext1 = ""; for i=1,#spellids do local fwid = spellids[i] + 0; if fwid and fwid > 0 and spells[fwid] then text = spells[fwid][1]; if text and text ~= "" then runetext1 = runetext1..text.."\n"; end; end; end; if runetext1 ~= "" and string.sub(runetext1, string.len(runetext1), -1) == "\n" then runetext1 = string.sub(runetext1, 1, string.len(runetext1)-1); end; local runeids = aaData:toVectorInt(item[24]); local runetext = ""; for i=1,#runeids do local fwid = runeids[i] + 0; if fwid and fwid > 0 and spells[fwid] then text = spells[fwid][1]; if text and text ~= "" then runetext = runetext..text.."\n"; end; end; end; if runetext ~= "" and string.sub(runetext, string.len(runetext), -1) == "\n" then runetext = string.sub(runetext, 1, string.len(runetext)-1); end; local lrtf = ""; if item[25] then lrtf = item[25]; end; local fwlevel = aaData:get_star(item[23]); if fwlevel == "无" then fwlevel = aaData.color_red.."可觉醒"; end; local qhlevel = aaData:get_star(item[19]); if qhlevel == "无" then qhlevel = aaData.color_red.."可强化"; end; tiaojiantext = aaData.color_yellow.."\n[宠物属性]等级："..qhlevel..aaData.color_green.."\n进化品质："..leveltext.."\n"..aaData.color_green.."力量资质："..lltext.."\n"..aaData.color_green.."敏捷资质："..mjtext.."\n"..aaData.color_green.."智力资质："..zltext.."\n"..aaData.color_green.."精神资质："..jstext.."\n"..aaData.color_green.."耐力资质："..nltext.."\n\n"..aaData.color_yellow.."["..lrtf.."天赋]等级："..aaData:get_star(item[8]).."\n"..aaData.color_yellows..runetext1.."\n\n"..aaData.color_yellow.."[觉醒技能]等级："..fwlevel.."\n"..aaData.color_yellows..runetext; local upgradeid = item[19] + 1; if petupgrade[upgradeid] and petupgrade[upgradeid][1] == item[18] then local needid = petupgrade[upgradeid][7]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑强化消耗|r\n"..need; end; end; end; local petnonsuchid = item[6] + 1; if petnonsuch[petnonsuchid] and petnonsuch[petnonsuchid][1] == item[7] then local needid = petnonsuch[petnonsuchid][5]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑进化消耗|r\n"..need; end; end; end; local runeid = item[21] + 1; if petrune[runeid] and petrune[runeid][1] == item[22]  then local needid = petrune[runeid][5]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑觉醒消耗|r\n"..need; end; end; end; if petnonsuch[petnonsuchid - 1] then if worldconf[3] then local needid = worldconf[3]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑重生消耗|r\n"..need; end; end; end; end; else if item[7] and item[7] > 0 then local petnonsuchid = 0; for k,v in pairs(petnonsuch) do if v and v[1] == item[7] and v[2] == 1 then petnonsuchid = k; end; end; if petnonsuchid > 0 then local needid = petnonsuch[petnonsuchid][5]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑孵化消耗|r\n"..need; end; end; end; end; if self == GameTooltip then GameTooltipTextLeft1:SetText(aaData.color_white..aaDataPet:get_dbname(selectItemId, itementry, item[5]).."（未孵化）"); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft1:SetText(aaData.color_white..aaDataPet:get_dbname(selectItemId, itementry, item[5]).."（未孵化）"); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft1:SetText(aaData.color_white..aaDataPet:get_dbname(selectItemId, itementry, item[5]).."（未孵化）"); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft1:SetText(aaData.color_white..aaDataPet:get_dbname(selectItemId, itementry, item[5]).."（未孵化）"); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft1:SetText(aaData.color_white..aaDataPet:get_dbname(selectItemId, itementry, item[5]).."（未孵化）"); end; end; self:Show(); isPet = 1; end; end; if isPet == 0 then item = aaData:getItem(selectItemId, itementry); if item ~= nil then local fwname = ""; local bs = get_bs_fontstring(self); local fg = get_fg_fontstring(self); local sd = get_delay_fontstring(self); if itementry > 0 and aa_fw[itementry] and aa_fw[itementry] ~= nil and aa_fw[itementry] ~= "" and selectItemId <= 0 and aa_fw[itementry] ~= nil and aa_fw[itementry] ~= "" then fwname = name.."\n"..aa_fw[itementry]; if self == GameTooltip then GameTooltipTextLeft1:SetText(fwname); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft1:SetText(fwname); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft1:SetText(fwname); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft1:SetText(fwname); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft1:SetText(fwname); end; end; if  item and item ~= {} and item[2]+0 == itementry+0 then local title = aaData:get_name(selectItemId, itementry, name); if item[32] > 0 and worldconf[8] == 1 and aaDzTooltip.fwhide == 0 then local point, relativeTo, relativePoint, xOfs, yOfs = self:GetPoint() local fwPoint = nil; if point == "BOTTOMLEFT" then fwPoint = "TOPLEFT"; elseif point == "BOTTOMRIGHT" then fwPoint = "TOPRIGHT"; elseif point == "BOTTOM" then fwPoint = "TOPLEFT"; relativePoint = "TOPRIGHT"; end; if fwPoint == "TOPLEFT" then aaFwTooltipLeft:show(item); aaFwTooltipLeft.mainView:SetPoint(fwPoint,self,relativePoint); elseif fwPoint == "TOPRIGHT" then aaFwTooltipRight:show(item); aaFwTooltipRight.mainView:SetPoint(fwPoint,self,relativePoint); end; end; local itemlevel = nil; local level = item[19]; for i=1,#itemlevels do if itemlevels[i][1] == item[17] and itemlevels[i][2] == level then itemlevel = itemlevels[i]; end; end; if worldconf[6] == 1 and item[10] ~= 0 then local upgradeid = item[11]+0; local level = 0; local reward = ""; if upgrade[upgradeid] then level = upgrade[upgradeid][1]+0; if upgrade[upgradeid][7] ~= "" and upgrade[upgradeid][7] ~= "0" and upgrade[upgradeid][7] ~= 0 then reward = reward.."属性﹢"..upgrade[upgradeid][7]; end; if upgrade[upgradeid][8] ~= "" and upgrade[upgradeid][8] ~= "0" and upgrade[upgradeid][8] ~= 0 then if reward ~= "" then reward = reward.."，"; end; reward = reward.."加成﹢"..upgrade[upgradeid][8].."%"; end; end; local qhstar = aaData:get_star(level); if qhstar == "无" then qhstar = aaData.color_red.."可强化|r"; else qhstar = qhstar; end; if level > 0 then title = title.." ﹢"..level; end; if reward ~= "" then title = title.."\n"..qhstar.."\n"..aaData.color_green.."﹢"..level.."强化奖励："..aaData.color_green..reward; else title = title.."\n"..qhstar; end; local qhtext = ""; if item[16] ~= "" and item[16] ~= "0" and item[16] ~= 0 then local qhtext1 = item[16]; local qhids = {}; string.gsub(qhtext1,'[^'..","..']+',function (w) table.insert(qhids,w); end); for i=1,#qhids do local qhid = qhids[i] + 0; if qhid > 0 and spells[qhid] then local spelltext = spells[qhid][1]; if spelltext and spelltext ~= "" then local text21 = aaData:autoLine(spelltext, 21); qhtext = qhtext..text21.."\n"; end; end; end; end; if qhtext ~= "" then bottomtext = bottomtext..qhtext; end; end; local jd = get_jd_fontstring(self); local toptext = ""; local itemCount = item[32] + 0; local jdtext = aaData:get_quality_text(selectItemId, itementry); if jdtext ~= "" then toptext = toptext..aaData.color_yellows.."鉴定品质：|r"..jdtext; end; if itemCount > 0 then if jdtext ~= "" then toptext = toptext..aaData.color_gray.." | |r"..aaData.color_yellows.."符文凹槽：|r"..itemCount; else toptext = toptext..aaData.color_yellows.."符文凹槽：|r"..itemCount; end; end; if item and worldconf[12] == 1 and item[17] > 0 then if toptext ~= "" then toptext = toptext.."\n"; end; local itemlevel = nil; local itemlevel_n = nil; local level = item[19]; local level_n = item[19]+1; for i=1,#itemlevels do if itemlevels[i][1] == item[17] and itemlevels[i][2] == level then itemlevel = itemlevels[i]; end; if itemlevels[i][1] == item[17] and itemlevels[i][2] == level_n then itemlevel_n = itemlevels[i]; end; end; local reward = ""; if itemlevel ~= nil and itemlevel[8] ~= "" and itemlevel[8] ~= "0" and itemlevel[8] ~= 0 then reward = reward.."属性﹢"..itemlevel[8]; end; if itemlevel ~= nil and itemlevel[9] ~= "" and itemlevel[9] ~= "0" and itemlevel[9] ~= 0 then if reward ~= "" then reward = reward.."，"; end; reward = reward.."加成﹢"..itemlevel[9].."%"; end; if reward ~= "" and item[19] > 0 then if title ~= "" then title = title.."\n"; end; title = title..aaData.color_green.."﹢"..level.."成长奖励："..aaData.color_green..reward; end; if itemlevel_n ~= nil and itemlevel_n[3] > 0 then toptext = toptext..aaData.color_green.."成长等级： "..aaData.color_green.."Lv."..level.."\n"..aaData.color_green.."成长经验： "..aaData.color_green..item[20].." / "..itemlevel_n[3]; else toptext = toptext..aaData.color_green.."成长等级： "..aaData.color_green.."Lv.已满级\n"..aaData.color_green.."成长经验： max"; end; local lvtext = ""; if item[24] ~= "" and item[24] ~= "0" and item[24] ~= 0 then local lvtext1 = item[24]; local lvids = {}; string.gsub(lvtext1,'[^'..","..']+',function (w) table.insert(lvids,w); end); for i=1,#lvids do local lvid = lvids[i] + 0; if lvid > 0 and spells[lvid] then if spells[lvid][1] then local spelltext = spells[lvid][1]; if spelltext and spelltext ~= "" then local text21 = aaData:autoLine(spelltext, 21); lvtext = lvtext..text21.."\n"; end; end; end; end; end; if lvtext ~= "" then bottomtext = bottomtext..lvtext; end; end; if aa_fw[itementry] and aa_fw[itementry] ~= nil and aa_fw[itementry] ~= "" then if title ~= "" then title = title.."\n"; end; title = title..aa_fw[itementry]; end; if self == GameTooltip then GameTooltipTextLeft1:SetText(title); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft1:SetText(title); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft2:SetText(title); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft1:SetText(title); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft1:SetText(title); end; if item[36] ~= "" and item[36] ~= "-1" then local sub = item[36]; if aaData.subclass_name[sub] then title = title.."\n"..aaData.color_green.."萃取部位："..aaData.subclass_name[sub];     if self == GameTooltip then GameTooltipTextLeft1:SetText(title); elseif self == ItemRefTooltip then ItemRefTooltipTextLeft1:SetText(title); elseif self == ShoppingTooltip1 then ShoppingTooltip1TextLeft2:SetText(title); elseif self == ShoppingTooltip2 then ShoppingTooltip2TextLeft1:SetText(title); elseif self == ShoppingTooltip3 then ShoppingTooltip3TextLeft1:SetText(title); end; end; end; if jd ~= nil and toptext ~= "" then jd:SetSpacing(4); jd:SetText(toptext.."|r\n"..jd:GetText()); end; local fugai = aaData:toVectorInt2(item[5]); local jdvalue = aaData:toVectorInt(item[9]); local qhvalue = aaData:toVectorInt(item[13]); local qhrewardval = item[14] + 0; local qhrewardper = item[15] + 0; local czvalue = aaData:toVectorInt(item[21]); local czrewardval = item[22] + 0; local czrewardper = item[23] + 0; local fugaikey = {}; local mindmg0 = 0; local maxdmg0 = 0; local mindmg1 = 0; local maxdmg1 = 0; local mindmg2 = 0; local maxdmg2 = 0; local mindmg3 = 0; local maxdmg3 = 0; local mindmg4 = 0; local maxdmg4 = 0; local mindmg5 = 0; local maxdmg5 = 0; local mindmg6 = 0; local maxdmg6 = 0; local mindmg01 = 0; local maxdmg01 = 0; local mindmg11 = 0; local maxdmg11 = 0; local mindmg21 = 0; local maxdmg21 = 0; local mindmg31 = 0; local maxdmg31 = 0; local mindmg41 = 0; local maxdmg41 = 0; local mindmg51 = 0; local maxdmg51 = 0; local mindmg61 = 0; local maxdmg61 = 0; local dmgtext0 = ""; local dmgtext1 = ""; local dmgtext2 = ""; local dmgtext3 = ""; local dmgtext4 = ""; local dmgtext5 = ""; local dmgtext6 = ""; local delay = 0; local armor = 0; local block = 0; local delay1 = 0; local armor1 = 0; local block1 = 0; local delaytext = ""; local armortext = ""; local blocktext = ""; local fugai_value = {}; for typeid,v in pairs(fugai) do local value = fugai[typeid]+0; if value > 0 then table.insert(fugaikey,typeid); if stats[typeid+0] ~= nil then if stats[typeid+0][1] ~= nil then local type = stats[typeid+0][1] + 0; fugai_value[type] = value; end; end; end; end; local fmtext_value = ""; local fmtext_spell = ""; local fumovalue = aaData:toVectorInt2m(item[28]); local fmvalues = {}; local fumovalues = {}; for i,v in pairs(fumovalue) do local fmid = nil; local fmvalue = nil; if v then for k1, v1 in pairs(v) do if fumovalues[k1] == nil then fumovalues[k1] = 0; end; fumovalues[k1] = fumovalues[k1] + v1; end end; end; local fmkey = {}; for typeid,v in pairs(fumovalues) do if v > 0 then table.insert(fmkey,typeid); end; end; for i=1,#fmkey do local fmid = fmkey[i]; local fmvalue = fumovalues[fmid]; local type = 0; if fmid and stats[fmid] then type = stats[fmid][1] + 0; local value = 0; if fmvalues[type] == nil then fmvalues[type] = 0; end; if fmvalue then if type == 999999 then local text = stats[fmid][2]; fmtext_value = fmtext_value..text.."\n"; elseif type <= 7 then if fmvalue and fmvalue > 0 then if fugai_value[type] == nil or fugai_value[type] == 0 then local text = stats[fmid][2]; fmtext_value = fmtext_value.."+"..fmvalue.." "..text.."\n"; end;  fmvalues[type] = fmvalues[type] + fmvalue; end; elseif type == 201 or type == 203 or type == 205 or type == 207 or type == 209 or type == 211 or type == 213 or type == 215 or type == 217 or type == 219 or type == 221 or type == 228 or type == 229 or type == 230 or type == 301 or type == 303 or type == 305 or type == 307 or type == 309 or type == 311 or type == 313 or type == 315 or type == 317 or type == 319 or type == 321 or type == 328 or type == 329 or type == 330 or type == 400 or type == 401 or type == 403 or type == 405 or type == 406 or type == 500 or type == 501 or type == 503 or type == 504 or type == 505 or type == 506 or type == 507 or type == 519  or type == 520  or type == 521  or type == 528  or type == 529  or type == 530 or type == 538 or type == 545 then if fmvalue and fmvalue > 0 then if fugai_value[type] == nil or fugai_value[type] == 0 then local text = stats[fmid][2]; fmtext_spell = fmtext_spell..text..fmvalue.."%".."。".."\n"; end;  fmvalues[type] = fmvalues[type] + fmvalue; end; elseif type == 38 or type == 45 then  if fmvalue and fmvalue > 0 then if fugai_value[type] == nil or fugai_value[type] == 0 then local text = stats[fmid][2]; fmtext_spell = fmtext_spell..aaData.color_green..text..fmvalue.."点。".."\n"; end;  fmvalues[type] = fmvalues[type] + fmvalue; end; else if fmvalue and fmvalue > 0 then if fugai_value[type] == nil or fugai_value[type] == 0 then local text = stats[fmid][2]; fmtext_spell = fmtext_spell..aaData.color_green..text..fmvalue.."。".."\n"; end;  fmvalues[type] = fmvalues[type] + fmvalue; end; end; end; end; end; table.sort(fugaikey,function(a,b)return (tonumber(a)<tonumber(b)) end); local fugaiview = ""; local typecount = 0; local typeindex = 0; for i=1,#fugaikey do local typeid = fugaikey[i]; if stats[typeid+0] ~= nil then if stats[typeid+0][1] ~= nil then local type = stats[typeid+0][1] + 0; if type < 120 or type > 136 then typecount = typecount + 1; end; end; end; end; local minmaxcount = 0; local minmaxdmg0 = 0; for i=1,#fugaikey do local typeid = fugaikey[i]; local value = fugai[typeid]+0; local valuep = 0; local valueJp = 0; if jdvalue[i] then valueJp = valueJp+jdvalue[i]+0; end; if qhvalue[i] then valuep = valuep+qhvalue[i]+0; end; if qhrewardval > 0 then valuep = valuep+qhrewardval; end; if qhrewardper > 0 then valuep = valuep+value*qhrewardper/100; end; if czvalue[i] then valuep = valuep+czvalue[i]+0; end; if czrewardval > 0 then valuep = valuep+czrewardval; end; if czrewardper > 0 then valuep = valuep+value*czrewardper/100; end; valuep = aaData:toint(valuep);  if stats[typeid+0] ~= nil then if stats[typeid+0][1] ~= nil then local type = stats[typeid+0][1] + 0; if type < 120 or type > 136 then typeindex = typeindex + 1; local fmvalue = 0; if fmvalues[type] ~= nil and fmvalues[type] > 0 then fmvalue = fmvalues[type]; end; if typeindex == typecount then if type <= 7 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview.."+"..value+valuep+valueJp+fmvalue.." "..stats[typeid+0][2]..v.."|r"; elseif type == 201 or type == 203 or type == 205 or type == 207 or type == 209 or type == 211 or type == 213 or type == 215 or type == 217 or type == 219 or type == 221 or type == 228 or type == 229 or type == 230 or type == 301 or type == 303 or type == 305 or type == 307 or type == 309 or type == 311 or type == 313 or type == 315 or type == 317 or type == 319 or type == 321 or type == 328 or type == 329 or type == 330 or type == 400 or type == 401 or type == 403 or type == 405 or type == 406 or type == 500 or type == 501 or type == 503 or type == 504 or type == 505 or type == 506 or type == 507 or type == 519  or type == 520  or type == 521  or type == 528  or type == 529  or type == 530 or type == 538 or type == 545 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."%]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..stats[typeid+0][2]..value+valuep+valueJp+fmvalue.."%".."。"..v.."|r"; elseif type == 38 or type == 45 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..aaData.color_green..stats[typeid+0][2].." "..value+valuep+valueJp+fmvalue.."点。"..v.."|r"; else local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..aaData.color_green..stats[typeid+0][2].." "..value+valuep+valueJp+fmvalue.."。"..v.."|r"; end; else if type <= 7 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview.."+"..value+valuep+valueJp+fmvalue.." "..stats[typeid+0][2]..v.."|r\n"; elseif type == 201 or type == 203 or type == 205 or type == 207 or type == 209 or type == 211 or type == 213 or type == 215 or type == 217 or type == 219 or type == 221 or type == 228 or type == 229 or type == 230 or type == 301 or type == 303 or type == 305 or type == 307 or type == 309 or type == 311 or type == 313 or type == 315 or type == 317 or type == 319 or type == 321 or type == 328 or type == 329 or type == 330 or type == 400 or type == 401 or type == 403 or type == 405 or type == 406 or type == 500 or type == 501 or type == 503 or type == 504 or type == 505 or type == 506 or type == 507 or type == 519 or type == 520  or type == 521  or type == 528  or type == 529  or type == 530 or type == 538 or type == 545 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.." [+"..valuep.."%]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..stats[typeid+0][2]..value+valuep+valueJp+fmvalue.."%".."。"..v.."|r\n"; elseif type == 38 or type == 45 then local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.."[+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..aaData.color_green..stats[typeid+0][2].." "..value+valuep+valueJp+fmvalue.."点。"..v.."|r\n"; else local v = ""; if valuep + 0 > 0 then v = aaData.color_reds.."[+"..valuep.."]|r"; end; if fmvalue > 0 then v = v..aaData.color_reds.." [+"..fmvalue.."]|r"; end; fugaiview = fugaiview..aaData.color_green..stats[typeid+0][2].." "..value+valuep+valueJp+fmvalue.."。"..v.."|r\n"; end; end; else if type >= 121 and type <= 134 then if minmaxcount <= 2 then minmaxdmg0 = minmaxdmg0 + value; end; minmaxcount = minmaxcount + 1; end; local valuetext = stats[typeid+0][2]; if type == 120 then delay = value; delay1 = valuep+valueJp; delaytext = valuetext; elseif type == 121 then mindmg0 = value+valuep+valueJp; mindmg01 = valuep; elseif type == 122 then maxdmg0 = value+valuep+valueJp; maxdmg01 = valuep; dmgtext0 = valuetext; elseif type == 123 then mindmg1 = value+valuep+valueJp; mindmg11 = valuep; elseif type == 124 then maxdmg1 = value+valuep+valueJp; maxdmg11 = valuep; dmgtext1 = valuetext; elseif type == 125 then mindmg2 = value+valuep+valueJp; mindmg21 = valuep; elseif type == 126 then maxdmg2 = value+valuep+valueJp; maxdmg21 = valuep; dmgtext2 = valuetext; elseif type == 127 then mindmg3 = value+valuep+valueJp; mindmg31 = valuep; elseif type == 128 then maxdmg3 = value+valuep+valueJp; maxdmg31 = valuep; dmgtext3 = valuetext; elseif type == 129 then mindmg4 = value+valuep+valueJp; mindmg41 = valuep; elseif type == 130 then maxdmg4 = value+valuep+valueJp; maxdmg41 = valuep; dmgtext4 = valuetext; elseif type == 131 then mindmg5 = value+valuep+valueJp; mindmg51 = valuep; elseif type == 132 then maxdmg5 = value+valuep+valueJp; maxdmg51 = valuep; dmgtext5 = valuetext; elseif type == 133 then mindmg6 = value+valuep+valueJp; mindmg61 = valuep; elseif type == 134 then maxdmg6 = value+valuep+valueJp; maxdmg61 = valuep; dmgtext6 = valuetext; elseif type == 135 then armor = value+valuep+valueJp; armor1 = valuep; armortext = valuetext; elseif type == 136 then block = value+valuep+valueJp; block1 = valuep; blocktext = valuetext; end; end; end; end; end; local miaoshang = 0; local views = {}; local viewi = 0; if item[35] ~= nil and item[35] ~= "" and item[35] ~= "0" then local i = 0; local count07 = 0; local count78 = 0; string.gsub(item[35],'[^'..","..']+',function (w) if i == 0 then count07 = w + 0; else count78 = w + 0; end; i = i+1; end); local index07 = 0; local index78 = 0; for i=1,self:NumLines() do local mytext=_G[pretext.."TextLeft"..i]; local text=mytext:GetText(); _, qe=string.find(text, "%d点护甲"); if qe ~= nil and i ~= 1 then _G[pretext.."TextLeft"..i]:SetText(""); viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; end; _, qe=string.find(text, "(%d+).*-.*(%d+)伤害"); if qe ~= nil and i ~= 1 then _G[pretext.."TextLeft"..i]:SetText(""); viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; end; _, qe=string.find(text, "每秒伤害"); if qe ~= nil and i ~= 1 then miaoshang1,miaoshang2 = string.match(text, '秒伤害(%d+).(%d+)'); miaoshang = miaoshang1.."."..miaoshang2; _G[pretext.."TextLeft"..i]:SetText(""); viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; end; _, qe=string.find(text, "%d格挡"); if qe ~= nil then _G[pretext.."TextLeft"..i]:SetText(""); viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; end; if index07 < count07 then _, qe1=string.find(text, "+"); _, qe2=string.find(text, "-"); if qe1 ~= nil and qe2 == nil and i ~= 1 then viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; index07 = index07 + 1; end; end; if index78 < count78 then _, qe=string.find(text, "装备："); if qe ~= nil and i ~= 1 then viewi = viewi + 1; views[viewi] = _G[pretext.."TextLeft"..i]; index78 = index78 + 1; end; end; local rmytext=_G[pretext.."TextRight"..i]; local rtext=mytext:GetText(); _, qe=string.find(text, "速度(%d+)"); if qe ~= nil then _G[pretext.."TextRight"..i]:SetText(""); end; end; end; if views ~= nil and views[1] ~= nil then local dmg0 = ""; local dmg1 = ""; local dmg2 = ""; local dmg3 = ""; local dmg4 = ""; local dmg5 = ""; local dmg6 = ""; local armorview = ""; local blockview = ""; if armor > 0 then if armor1 > 0 then armorview = armor..armortext.."(+"..armor1..")"; else armorview = armor..armortext; end; end; if block > 0 then if block1 > 0 then blockview = block..blocktext.."(+"..block1..")"; else blockview = block..blocktext; end; end; local miaoshangbeilv = 0; local minmaxdmg1 = 0; if mindmg0 > 0 and maxdmg0 > 0 then local mintext = ""; local maxtext = ""; if mindmg01 > 0 then mintext = mindmg0.."(+"..mindmg01..")"; else mintext = mindmg0; end; if maxdmg01 > 0 then maxtext = maxdmg0.."(+"..maxdmg01..")"; else maxtext = maxdmg0; end; dmg0 = mintext.." - "..maxtext..dmgtext0; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg0 + maxdmg0; end; end; if mindmg1 > 0 and maxdmg1 > 0 then local mintext = ""; local maxtext = ""; if mindmg11 > 0 then mintext = mindmg1.."(+"..mindmg11..")"; else mintext = mindmg1; end; if maxdmg11 > 0 then maxtext = maxdmg1.."(+"..maxdmg11..")"; else maxtext = maxdmg1; end; dmg1 = mintext.." - "..maxtext..dmgtext1; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg1 + maxdmg1; end; end; if mindmg2 > 0 and maxdmg2 > 0 then local mintext = ""; local maxtext = ""; if mindmg21 > 0 then mintext = mindmg2.."(+"..mindmg21..")"; else mintext = mindmg2; end; if maxdmg21 > 0 then maxtext = maxdmg2.."(+"..maxdmg21..")"; else maxtext = maxdmg2; end; dmg2 = "+"..mintext.." - "..maxtext..dmgtext2; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg2 + maxdmg2; end; end; if mindmg3 > 0 and maxdmg3 > 0 then local mintext = ""; local maxtext = ""; if mindmg31 > 0 then mintext = mindmg3.."(+"..mindmg31..")"; else mintext = mindmg3; end; if maxdmg31 > 0 then maxtext = maxdmg3.."(+"..maxdmg31..")"; else maxtext = maxdmg3; end; dmg3 = "+"..mintext.." - "..maxtext..dmgtext3; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg3 + maxdmg3; end; end; if mindmg4 > 0 and maxdmg4 > 0 then local mintext = ""; local maxtext = ""; if mindmg41 > 0 then mintext = mindmg4.."(+"..mindmg41..")"; else mintext = mindmg4; end; if maxdmg41 > 0 then maxtext = maxdmg4.."(+"..maxdmg41..")"; else maxtext = maxdmg4; end; dmg4 = "+"..mintext.." - "..maxtext..dmgtext4; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg4 + maxdmg4; end; end; if mindmg5 > 0 and maxdmg5 > 0 then local mintext = ""; local maxtext = ""; if mindmg51 > 0 then mintext = mindmg5.."(+"..mindmg51..")"; else mintext = mindmg5; end; if maxdmg51 > 0 then maxtext = maxdmg5.."(+"..maxdmg51..")"; else maxtext = maxdmg5; end; dmg5 = "+"..mintext.." - "..maxtext..dmgtext5; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg5 + maxdmg5; end; end; if mindmg6 > 0 and maxdmg6 > 0 then local mintext = ""; local maxtext = ""; if mindmg61 > 0 then mintext = mindmg6.."(+"..mindmg61..")"; else mintext = mindmg6; end; if maxdmg61 > 0 then maxtext = maxdmg6.."(+"..maxdmg61..")"; else maxtext = maxdmg6; end; dmg6 = "+"..mintext.." - "..maxtext..dmgtext6; if minmaxdmg1 == 0 then minmaxdmg1 = mindmg6 + maxdmg6; end; end; if minmaxdmg1 > 0 then if delay <= 0 then delay = 2000; end; miaoshang = string.format("%.2f", minmaxdmg1 * 1000 * 0.5 / delay) + 0; end; local fgtext = ""; if dmg0 ~= "" then fgtext = fgtext..dmg0.."\n"; end; if dmg1 ~= "" then fgtext = fgtext..dmg1.."\n"; end; if dmg2 ~= "" then fgtext = fgtext..dmg2.."\n"; end; if dmg3 ~= "" then fgtext = fgtext..dmg3.."\n"; end; if dmg4 ~= "" then fgtext = fgtext..dmg4.."\n"; end; if dmg5 ~= "" then fgtext = fgtext..dmg5.."\n"; end; if dmg6 ~= "" then fgtext = fgtext..dmg6.."\n"; end; if miaoshang ~= "0" and miaoshang ~= 0 then fgtext = fgtext.."（每秒伤害"..miaoshang.."）\n"; end; if armorview ~= "" then fgtext = fgtext..armorview.."\n"; end; if blockview ~= "" then fgtext = fgtext..blockview.."\n"; end; if fmtext_value ~= "" then if fmtext_value ~= "" and string.sub(fmtext_value, string.len(fmtext_value), -1) == "\n" then fmtext_value = string.sub(fmtext_value, 1, string.len(fmtext_value)-1); end; fgtext = aaData.color_white..fgtext.."|r"..fugaiview.."\n"..fmtext_value; elseif fugaiview ~= "" then fgtext = aaData.color_white..fgtext.."|r"..fugaiview; end; local i = 0; local w_last = ""; local i_value = 0; local i_spell = 0; string.gsub(fgtext,'[^'.."\n"..']+',function (w) if w ~= nil and w ~= "" and w ~= "0" and w ~= "\n" and w ~= 0 then i = i + 1; if views[i] ~= nil then views[i]:SetSpacing(4); views[i]:SetText(w); _, q=string.find(w, "装备"); if q == nil then i_value = i_value + 1; end; i_spell = i_spell + 1; else w_last = w_last.."\n"..w; end; end; end); views[i_value]:SetText(views[i_value]:GetText()..w_last); local fumospell = aaData:toVectorInt(item[26]); local fwtext = "\n"; for i=1,#fumospell do local fwid = fumospell[i] + 0; if fwid and fwid > 0 and spells[fwid] then text = spells[fwid][1]; if text and text ~= "" then local text21 = aaData:autoLine(text, 21); fwtext = fwtext..text21.."\n"; end; end; end; if fwtext ~= "" and string.sub(fwtext, string.len(fwtext), -1) == "\n" then fwtext = string.sub(fwtext, 1, string.len(fwtext)-1); end; if fmtext_spell ~= "" then if fmtext_spell ~= "" and string.sub(fmtext_spell, string.len(fmtext_spell), -1) == "\n" then fmtext_spell = string.sub(fmtext_spell, 1, string.len(fmtext_spell)-1); end; views[i_spell]:SetText(views[i_spell]:GetText().."\n"..fmtext_spell..fwtext); else views[i_spell]:SetText(views[i_spell]:GetText()..fwtext); end; end; if sd ~= nil then local delayview = ""; if delay > 0 then local delayf = (delay+0)/1000; delayview = delaytext..delayf; end; sd:SetText(delayview); end; if bs ~= nil then local text = nil; if aa_bs[itementry] then text = aa_bs[itementry]; elseif item[37] then local baoshi_entry = item[37] + 0; if baoshi_entry > 0 then if aa_bs[baoshi_entry] then text = aa_bs[baoshi_entry]; end; end; end; if text ~= nil then bs:SetText(text); end; end; if item[38] then if item[38] + 0 > 0 then local itemset = item[38]; local itemsets = aa_itemsets[itemset]; local min = 0; if itemsets ~= nil then min = #itemsets; local max = 0; if aa_itemset_list[itemset] ~= nil then max = #aa_itemset_list[itemset]; end; local itemset_name = ""; if aa_itemset_conf[itemset] ~= nil then itemset_name = aa_itemset_conf[itemset][1]; end; local itemset_tooltip = aaData.color_yellow..itemset_name.."（"..min.."/"..max.."）|r|r|r"; bottomtext = bottomtext.."\n"..itemset_tooltip; if #itemsets == 0 then local _, name1, _= strsplit("[", itemLink); local itemName, _= strsplit("]", name1); bottomtext = bottomtext.."\n".."  "..aaData.color_gray..aaData:get_dbname(suffixId,itementry,itemName); else for i=1, #itemsets do local itemLink = itemsets[i]; local _, name1, _= strsplit("[", itemLink); local itemName, _= strsplit("]", name1); bottomtext = bottomtext.."\n".."  "..itemName; end; end; end; if aa_itemset_list[itemset] ~= nil then bottomtext = bottomtext.."\n"; for k,v in pairs(aa_itemset_list[itemset]) do if v[4] ~= nil then local count = v[3]; local text = v[4]; local text1 = aaData:autoLine(text, 21); if itemsets ~=nil and #itemsets >= count then text = aaData.color_green..text1; else text = aaData.color_gray..text1; end; bottomtext = bottomtext.."\n"..text; end; end; end; end; end; local upgroup = item[10]; if upgroup > 0 then local upgradeid1 = item[11]; local upgradeid2 = 0; local isok = 0; if upgradeid1 == 0 then for i=1,#upgrade do local up = upgrade[i]; if up then if up[12] == upgroup then upgradeid2 = i; break; end; end; end; isok = 1; else upgradeid2 = upgradeid1 + 1; end; if upgrade[upgradeid1] and upgrade[upgradeid2] then if upgrade[upgradeid2][1] > upgrade[upgradeid1][1] then isok = 1; end; end; if  isok == 1 and upgrade[upgradeid2] then local needid = upgrade[upgradeid2][11]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext1 = tiaojiantext1..aaData.color_white.."∑强化消耗|r\n"..need; end; end; end; end; end; if itemtemplates[itementry] then local itemid = itemtemplates[itementry][6]; if itemid and itemid+0 > 0 then local itemname = aaData:getItemName(itemid); local needid = itemtemplates[itementry][7]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then if tiaojiantext1 ~= "" then tiaojiantext1 = tiaojiantext1.."\n"; end; tiaojiantext1 = tiaojiantext1..aaData.color_white.."∑物品合成|r\n"..aaData.color_yellow.."· 可合成|r"..aaData.color_blue.."["..itemname.."]".."\n"..need; end; end; end; end; if tiaojiantext1 ~= "" then if bottomtext ~= "" then bottomtext = bottomtext.."\n"; end; bottomtext = bottomtext..tiaojiantext1; end; end; end; if aa_item_huishou and aa_item_huishou[selectItemId] and aa_item_huishou[selectItemId][1] then local rewardid = aa_item_huishou[selectItemId][1]+0; if rewardid and rewardid ~= "" and rewardid > 0 then local reward = aaData:getReward(rewardid); if reward ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."∑回收获得|r\n"..reward; end; end; end;  selectItemIdPre = selectItemId; selectItemIdPres[selectItemId] = 1; if itemtemplates[itementry] then local needid = itemtemplates[itementry][3]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑使用消耗|r\n"..need; end; end; end; if itemtemplates[itementry] then local rewardid = itemtemplates[itementry][4]; if rewardid and rewardid ~= "" and rewardid > 0 then local reward = aaData:getReward(rewardid); if reward ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑使用获得|r\n"..reward; end; end; end; if UnitGUID("target") ~= nil then local ty = tonumber(UnitGUID("target"):sub(5,5),16); local g  = tonumber(UnitGUID("target"):sub(13,18),16); if g and ty == 3 then local creatureentry = tonumber(UnitGUID("target"):sub(8, 12), 16); if aaDzTooltip.selectCreatureEntry == creatureentry and aaDzTooltip.selectVendorEntry > 0 then local needid = 0; if vendors[aaDzTooltip.selectVendorEntry] then needid = vendors[aaDzTooltip.selectVendorEntry][itementry]; end; if needid == nil or needid == 0 or needid == "" then if vendors[1] then needid = vendors[1][itementry]; end; end; if needid == nil or needid == 0 or needid == "" then if vendors[0] then needid = vendors[0][itementry]; end; end; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑购买消耗|r\n"..need; end; end; end; end; end; if itemtemplates[itementry] then local rewardid = itemtemplates[itementry][5]; if rewardid and rewardid ~= "" and rewardid > 0 then local reward = aaData:getReward(rewardid); if reward ~= "" then tiaojiantext = tiaojiantext..aaData.color_white.."\n∑售卖获得|r\n"..reward; end; end; end; if item and ll ~= nil then local qualityid = item[7]+0; if qualityid ~= "" and qualityid ~= 0 then if nonsuch[qualityid] then local needid = nonsuch[qualityid][5]; if needid and needid ~= "" and needid > 0 then local need = aaData:getNeed(needid); if need ~= "" then local text = ""; _, q=string.find(need, "巅峰等级"); if q ~= nil then local dflevel = string.match(need, 'x(%d+)') + 0; if dflevel > 0 and aa_userinfo[1] then if aa_userinfo[1]+0 >= dflevel then ll:SetText(aaData.color_white.."需要巅峰等级 "..dflevel); else ll:SetText(aaData.color_red.."需要巅峰等级 "..dflevel); end; end; end; _, q=string.find(need, "斗气等级"); if q ~= nil then local dflevel = string.match(need, 'x(%d+)') + 0; if dflevel > 0 and aa_userinfo[2] then if aa_userinfo[2]+0 >= dflevel then ll:SetText(aaData.color_white.."需要斗气等级 "..dflevel); else ll:SetText(aaData.color_red.."需要斗气等级 "..dflevel); end; end; end; _, q=string.find(need, "军衔等级"); if q ~= nil then local dflevel = string.match(need, 'x(%d+)') + 0; if dflevel > 0 and aa_userinfo[3] then if aa_userinfo[3]+0 >= dflevel then ll:SetText(aaData.color_white.."需要军衔等级 "..dflevel); else ll:SetText(aaData.color_red.."需要军衔等级 "..dflevel); end; end; end; _, q=string.find(need, "会员等级"); if q ~= nil then local dflevel = string.match(need, 'x(%d+)') + 0; if dflevel > 0 and aa_userinfo[4] then if aa_userinfo[4]+0 >= dflevel then ll:SetText(aaData.color_white.."需要会员等级 "..dflevel); else ll:SetText(aaData.color_red.."需要会员等级 "..dflevel); end; end; end; end; end; end; end; end; if fm ~= nil and bottomtext ~= "" then fm:SetSpacing(4); if fm:GetText() then fm:SetText(fm:GetText().."|r\n"..bottomtext); else fm:SetText(bottomtext.."|r"); end; end; if tiaojiantext ~= "" then local tianjian = {}; string.gsub(tiaojiantext,'[^'.."\n"..']+',function (w) if w ~= nil and w ~= "" and w ~= "0" and w ~= "\n" and w ~= 0 then if string.find(w,"天赋]等级") or string.find(w,"技能]等级") or string.find(w,"属性]等级")  then self:AddLine(aaData.color_blue.."一一一一一一一一一一一一一一一一".."|r");  end; self:AddLine(w); end; end); end; if item then local qualityid = item[7]+0; if qualityid ~= "" and qualityid ~= 0 then if nonsuch[qualityid] then local bottomtext = nonsuch[qualityid][4]; if bottomtext ~= "" then self:AddLine(bottomtext); end; end; end; if item[39] and item[39] > 0 then local cur_time = date("%Y-%m-%d %H:%M:%S", item[39]); self:AddLine(aaData.color_red.."[到期时间] ："..cur_time); end; end; self:Show(); end; local AA_ModifyMoney = function(self, cost, maxcost) if ( not self.shownMoneyFrames ) then return; end; local moneyFrame; for i=1, self.shownMoneyFrames do moneyFrame = _G[self:GetName().."MoneyFrame"..i]; if(moneyFrame) then moneyFrame:Hide(); MoneyFrame_SetType(moneyFrame, "STATIC"); end; end; self.shownMoneyFrames = nil; if( not maxcost ) then SetTooltipMoney(self, cost, nil, string.format("%s:", SELL_PRICE)); else self:AddLine(string.format("%s:", SELL_PRICE), 1.0, 1.0, 1.0); local indent = string.rep(" ",4); SetTooltipMoney(self, cost, nil, string.format("%s%s:", indent, MINIMUM)); SetTooltipMoney(self, maxcost, nil, string.format("%s%s:", indent, MAXIMUM)); end; end; GameTooltip:HookScript("OnTooltipSetItem", function(self) ShowItemInfo(self); AA_ModifyMoney(self, self.cost, self.maxcost); end); ItemRefTooltip:HookScript("OnTooltipSetItem", function(self) ShowItemInfo(self); AA_ModifyMoney(self, self.cost, self.maxcost); end); ShoppingTooltip1:HookScript("OnTooltipSetItem", function(self) ShowItemInfo(self); aaDzTooltip.fwhide = 1; AA_ModifyMoney(self, self.cost, self.maxcost); end); ShoppingTooltip2:HookScript("OnTooltipSetItem", function(self) ShowItemInfo(self); aaDzTooltip.fwhide = 1; AA_ModifyMoney(self, self.cost, self.maxcost); end); ShoppingTooltip3:HookScript("OnTooltipSetItem", function(self) ShowItemInfo(self); aaDzTooltip.fwhide = 1; AA_ModifyMoney(self, self.cost, self.maxcost); end); GameTooltip:HookScript("OnTooltipAddMoney", function(self, cost, maxcost) self.cost = cost; self.maxcost = maxcost; end); ItemRefTooltip:HookScript("OnTooltipAddMoney", function(self, cost, maxcost) self.cost = cost; self.maxcost = maxcost; end); ShoppingTooltip1:HookScript("OnTooltipAddMoney", function(self, cost, maxcost) self.cost = cost; self.maxcost = maxcost; end); ShoppingTooltip2:HookScript("OnTooltipAddMoney", function(self, cost, maxcost) self.cost = cost; self.maxcost = maxcost; end); ShoppingTooltip3:HookScript("OnTooltipAddMoney", function(self, cost, maxcost) self.cost = cost; self.maxcost = maxcost; end); GameTooltip:HookScript("OnTooltipCleared", function(self) if worldconf[8] == 1 and selectItemId > 0 then aaFwTooltipLeft:hide(); aaFwTooltipRight:hide(); aaDzTooltip.fwhide = 0; end; selectItemId = 0; end); ItemRefTooltip:HookScript("OnTooltipCleared", function(self) if worldconf[8] == 1 and selectItemId > 0 then aaFwTooltipLeft:hide(); aaFwTooltipRight:hide(); aaDzTooltip.fwhide = 0; end; selectItemId = 0; end); ShoppingTooltip1:HookScript("OnTooltipCleared", function(self) if worldconf[8] == 1 and selectItemId > 0 then aaFwTooltipLeft:hide(); aaFwTooltipRight:hide(); aaDzTooltip.fwhide = 0; end; selectItemId = 0; end); ShoppingTooltip2:HookScript("OnTooltipCleared", function(self) if worldconf[8] == 1 and selectItemId > 0 then aaFwTooltipLeft:hide(); aaFwTooltipRight:hide(); aaDzTooltip.fwhide = 0; end; selectItemId = 0; end); ShoppingTooltip3:HookScript("OnTooltipCleared", function(self) if worldconf[8] == 1 and selectItemId > 0 then aaFwTooltipLeft:hide(); aaFwTooltipRight:hide(); aaDzTooltip.fwhide = 0; end; selectItemId = 0; end);